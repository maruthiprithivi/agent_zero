name: Enhanced CI Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'release/**'
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - master
      - develop
      - 'release/**'
  workflow_dispatch:
    inputs:
      run_security_scan:
        description: 'Run security scanning'
        required: false
        default: 'true'
        type: boolean
      run_performance_tests:
        description: 'Run performance tests'
        required: false
        default: 'false'
        type: boolean

env:
  # Global environment variables
  PYTHONUNBUFFERED: 1
  FORCE_COLOR: 1

jobs:
  # Pre-flight checks
  pre-flight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should-test: ${{ steps.changes.outputs.should-test }}
      branch-type: ${{ steps.branch.outputs.type }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine branch type
        id: branch
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "master" ]]; then
            echo "type=stable" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == "develop" ]]; then
            echo "type=development" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" =~ ^release/.* ]]; then
            echo "type=release" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" =~ ^feature/.* ]]; then
            echo "type=feature" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" =~ ^hotfix/.* ]]; then
            echo "type=hotfix" >> $GITHUB_OUTPUT
          else
            echo "type=other" >> $GITHUB_OUTPUT
          fi

      - name: Get version
        id: version
        run: |
          python scripts/version-manager.py current || echo "version=unknown" >> $GITHUB_OUTPUT

      - name: Check for changes requiring tests
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            should-test:
              - 'agent_zero/**'
              - 'tests/**'
              - 'pyproject.toml'
              - 'scripts/**'

  # Multi-platform testing
  test:
    name: Test (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: pre-flight
    if: needs.pre-flight.outputs.should-test == 'true'

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.11", "3.12", "3.13"]
        include:
          # Add additional combinations for stable branches
          - os: macos-latest
            python-version: "3.13"
            experimental: true
          - os: windows-latest
            python-version: "3.13"
            experimental: true

    continue-on-error: ${{ matrix.experimental || false }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: >-
            uv-v2-${{ matrix.os }}-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-v2-${{ matrix.os }}-${{ matrix.python-version }}-
            uv-v2-${{ matrix.os }}-

      - name: Install UV
        run: |
          pip install uv
          uv --version

      - name: Debug Python environment
        run: |
          python --version
          pip --version
          which python
          python -c "import sys; print('Python path:', sys.executable)"

      - name: Create virtual environment and install dependencies
        run: |
          uv venv
          # Install core dependencies first
          uv pip install clickhouse-connect>=0.8.18,<1.0
          uv pip install mcp>=1.0.0,<2.0
          uv pip install python-dotenv>=1.0.0,<2.0
          uv pip install python-oauth2>=1.1.1,<2.0
          # Install dev dependencies
          uv pip install pytest>=8.0.0
          uv pip install pytest-asyncio>=0.24.0
          uv pip install pytest-mock>=3.14.0
          # Install the package itself
          uv pip install -e .

      - name: Run Docker-based tests
        if: matrix.os == 'ubuntu-latest'
        run: |
          ./scripts/run-tests.sh

      - name: Run tests (non-Docker)
        if: matrix.os != 'ubuntu-latest'
        run: |
          uv run pytest -v --tb=short --cov=agent_zero --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Code quality and linting
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    needs: pre-flight

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-v2-lint-${{ hashFiles('pyproject.toml') }}
          restore-keys: uv-v2-lint-

      - name: Install UV and dependencies
        run: |
          pip install uv
          uv venv
          # Install minimal linting dependencies
          uv pip install ruff>=0.6.0
          uv pip install black>=24.0.0
          uv pip install mypy>=1.11.0
          # Install the package itself
          uv pip install -e .

      - name: Run Ruff linting
        run: |
          uv run ruff check agent_zero --output-format=github
        continue-on-error: true

      - name: Run Ruff formatting check
        run: |
          uv run ruff format --check agent_zero

      - name: Run Black formatting check
        run: |
          uv run black --check --diff agent_zero

      - name: Run MyPy type checking
        run: |
          uv run mypy agent_zero --show-error-codes
        continue-on-error: true

  # Security scanning
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: pre-flight
    if: github.event.inputs.run_security_scan != 'false'

    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install UV and security tools
        run: |
          pip install uv
          uv venv
          uv pip install -e .[security]

      - name: Run Bandit security scan
        run: |
          uv run bandit -r agent_zero -f json -o bandit-report.json
        continue-on-error: true

      - name: Run Safety vulnerability scan
        run: |
          uv run safety check --json --output safety-report.json
        continue-on-error: true

      - name: Run pip-audit
        run: |
          uv run pip-audit --format=json --output=pip-audit-report.json
        continue-on-error: true

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.json

  # Docker testing
  docker:
    name: Docker Tests
    runs-on: ubuntu-latest
    needs: pre-flight
    if: needs.pre-flight.outputs.should-test == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker test image
        run: |
          docker build -f docker/Dockerfile.test -t agent-zero-test .

      - name: Run tests in Docker
        run: |
          ./scripts/run-tests.sh

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-test-results
          path: test-results/

  # Build verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: pre-flight

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install build tools
        run: |
          pip install uv build twine

      - name: Build package
        run: |
          python -m build

      - name: Verify package
        run: |
          twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/

  # Summary job
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [pre-flight, test, lint, security, docker, build]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "Pre-flight: ${{ needs.pre-flight.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Docker: ${{ needs.docker.result }}"
          echo "Build: ${{ needs.build.result }}"

          if [[ "${{ needs.pre-flight.result }}" == "failure" || \
                "${{ needs.test.result }}" == "failure" || \
                "${{ needs.lint.result }}" == "failure" || \
                "${{ needs.build.result }}" == "failure" ]]; then
            echo "âŒ CI Pipeline failed"
            exit 1
          else
            echo "âœ… CI Pipeline succeeded"
          fi

      - name: Post summary
        run: |
          echo "## ðŸš€ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-flight | ${{ needs.pre-flight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch Type:** ${{ needs.pre-flight.outputs.branch-type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.pre-flight.outputs.version }}" >> $GITHUB_STEP_SUMMARY
